# Java Gradle CircleCI 2.0 configuration file
#
# Check https://circleci.com/docs/2.0/language-java/ for more details
#
version: 2.1

executors:
  gradle_executor: # declares a reusable executor for build and test
    docker:
    - image: circleci/openjdk:8-jdk
    working_directory: ~/working_dir
    environment:
      # Customize the JVM maximum heap limit
      JVM_OPTS: -Xmx3200m
      TERM: dumb

jobs:
  build:
    executor: gradle_executor
    steps:
    - checkout

    # Download and cache dependencies
    - restore_cache:
        keys:
        - v1-dependencies-{{ checksum "build.gradle" }}
        # fallback to using the latest cache if no exact match is found
        - v1-dependencies-

    - run: gradle dependencies

    - save_cache:
        paths:
        - ~/.gradle
        key: v1-dependencies-{{ checksum "build.gradle" }}

    - run: gradle build
      
    # Persist the specified paths into the workspace for use in downstream job. 
    - persist_to_workspace:
        # Must be an absolute path, or relative path from working_directory. 
        # This is a directory on the container which is taken to be the root directory of the workspace.
        root: .
        # Must be relative path from root
        paths:
        - .
        
  test:
    executor: gradle_executor
    steps:

    - attach_workspace:
        # Must be absolute path or relative path from working_directory
        at: ~/working_dir

    - run: gradle test
      
    - store_test_results:
        path: build/reports/cucumber
        
    - store_artifacts:
        path: build/reports/cucumber
        
    - store_artifacts:
        path: build/reports/junit

    # Persist the specified paths into the workspace for use in downstream job. 
    - persist_to_workspace:
        # Must be an absolute path, or relative path from working_directory. 
        # This is a directory on the container which is taken to be the root directory of the workspace.
        root: .
        # Must be relative path from root
        paths:
        - build/reports
        
  analyse:
    executor: gradle_executor
    steps:

    - attach_workspace:
        # Must be absolute path or relative path from working_directory
        at: ~/working_dir
      
    - run: gradle jacocoTestReport
  
    - store_artifacts:
        path: build/reports/jacoco/test
  
    - run:
        name: Upload to Codecov
        command: bash <(curl -s https://codecov.io/bash)
  
    - run:
        name: Sonarqube
        command: gradle sonarqube -Dsonar.login=$SONAR_LOGIN

    # Persist the specified paths into the workspace for use in downstream job. 
    - persist_to_workspace:
        # Must be an absolute path, or relative path from working_directory. 
        # This is a directory on the container which is taken to be the root directory of the workspace.
        root: .
        # Must be relative path from root
        paths:
        - build/reports/jacoco
        
  deployToDockerHub:
    executor: gradle_executor
    steps:

    - attach_workspace:
        # Must be absolute path or relative path from working_directory
        at: ~/working_dir
      
    - setup_remote_docker:
        docker_layer_caching: true
  
    - run: |
        docker login -u $DOCKER_USER -p $DOCKER_PW
        gradle dockerPush
  
    - add_ssh_keys
    - run:
        name: Keyscan to known hosts
        command: ssh-keyscan -H $DROPLET_HOST >> ~/.ssh/known_hosts
  
    - deploy:
        command: ssh -v $DROPLET_USER@$DROPLET_HOST "cd ~/gamezeug-docker-compose; git pull --ff-only; ./deploy.sh"
      
  deployToDroplets:
    executor: gradle_executor
    steps:
    - add_ssh_keys
    - run:
        name: Keyscan to known hosts
        command: ssh-keyscan -H $DROPLET_HOST >> ~/.ssh/known_hosts

    - deploy:
        command: ssh -v $DROPLET_USER@$DROPLET_HOST "cd ~/gamezeug-docker-compose; git pull --ff-only; ./deploy.sh"

workflows:
  version: 2
  workflow:
    jobs:
    - build
    - test:
        requires: 
          - build
    - analyse:
        requires: 
          - test
    - deployToDockerHub:
        requires: 
          - test
    - deployToDroplets:
        requires: 
          - deployToDockerHub

